<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTG Deck Builder</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b0c10">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MTGアプリ">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#13151b;
      --text:#e7e7e7;
      --muted:#a8a8a8;
      --line:#242836;
      --chip:#151a26;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:14px 16px 10px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      background:rgba(11,12,16,.92);
      backdrop-filter: blur(8px);
      z-index:10;
    }

    /* ===== Top tabs ===== */
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .tabsWrap{
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      position:relative;
      width:100%;
      max-width: 520px;
    }
    .tabsWrap::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      border-bottom:3px double rgba(255,255,255,.18);
      pointer-events:none;
    }
    .tabs{ display:flex; gap:8px; }
    .tabbtn{
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#121623;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      min-width: 88px;
    }
    .tabbtn[aria-selected="true"]{
      background:#1b2130;
      outline:2px solid rgba(255,255,255,.10);
    }
    .pill{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }

    /* ===== Search toolbar layout (requested) ===== */
    .searchToolbar{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .searchRow1{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .searchRow2{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .searchRow3{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-top:2px;
    }

    input[type="text"], input[type="search"]{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f1117;
      color:var(--text);
      width:100%;
      min-width: 0;
    }
    select, button{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#171b25;
      color:var(--text);
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ background:#1b2130; }

    /* search dropdowns shouldn't be super wide */
    select{
      max-width: 220px;
    }
    #order{ width: 190px; }
    #viewMode{ width: 160px; }

    label{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      user-select:none;
    }
    label input{ width:18px; height:18px; }

    .content{ padding:12px; }
    .panel{ background:var(--panel); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .status{
      padding:10px 12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:pre-wrap;
    }

    /* ===== Search results grid ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap:10px;
      padding:12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#0f1117;
      display:flex;
      flex-direction:column;
    }
    .card img{ width:100%; aspect-ratio: 0.714; object-fit:cover; background:#0b0c10; }
    .card .meta{ padding:10px; display:flex; flex-direction:column; gap:8px; }
    .card .name{ font-size:13px; line-height:1.25; font-weight:900; }
    .card .sub{ font-size:12px; color:var(--muted); }
    .card .actions{ display:flex; gap:6px; flex-wrap:wrap; }

    /* ===== Search results list (buttons under name, more dense) ===== */
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:12px;
    }
    .row{
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:10px;
      align-items:start;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0f1117;
      padding:10px;
    }
    .row img{
      width:56px;
      height:78px;
      object-fit:cover;
      border-radius:12px;
      background:#0b0c10;
      margin-top:2px;
    }
    .row .rmeta{ min-width:0; display:flex; flex-direction:column; gap:6px; }
    .row .rname{
      font-size:15px;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .row .rsub{
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .row .ractions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .row .ractions button{
      padding:10px 12px;
      border-radius:12px;
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* ===== Deck ===== */
    .deckWrap{ padding:12px; display:flex; flex-direction:column; gap:12px; }
    .deckTop{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .deckTopLeft{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .boards{ display:flex; gap:10px; }
    .board{
      flex:1;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0f1117;
      overflow:hidden;
      min-width:0;
    }
    .boardHead{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .boardHeadLeft{ display:flex; align-items:center; gap:10px; }
    .chev{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#121623;
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    .boardTitle{ font-size:14px; font-weight:900; }
    .boardCount{ font-size:12px; color:var(--muted); font-variant-numeric: tabular-nums; }

    .tileWrap{ padding:10px; }
    .tileGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(78px, 1fr));
      gap:6px;
      max-height: min(58dvh, 58vh);
      overflow:auto;
      padding-right:4px;
    }
    .tile{
      position:relative;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0b0c10;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .tile img{
      width:100%;
      aspect-ratio: 0.714;
      object-fit: cover;
      display:block;
      background:#07080c;
      pointer-events:none;
    }
    .badge{
      position:absolute;
      top:4px;
      right:4px;
      min-width:18px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      font-size:11px;
      font-weight:900;
      text-align:center;
      font-variant-numeric: tabular-nums;
      pointer-events:none;
    }

    /* Mobile layout */
    @media (max-width: 980px){
      .boards{ flex-direction: column; }
      .tileGrid{ max-height: min(46dvh, 46vh); }
      .tabsWrap{ max-width: 100%; }
      select{ max-width: 100%; }
    }
    /* Force 6 columns on phones (requested) */
    @media (max-width: 520px){
      .tileGrid{
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap:6px;
      }
      .badge{ font-size:10px; padding:2px 5px; }
      #order{ width: 160px; }
      #viewMode{ width: 150px; }
    }

    /* ===== Modal (smartphone safe) ===== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .modalOverlay.show{ display:flex; }

    .modal{
      width: min(920px, 100%);
      max-height: min(86dvh, 86vh);
      background: #10131a;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      display: flex;
      flex-direction: column;
    }
    .modalHeader{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
    }
    .modalTitle{ font-size:16px; font-weight:900; }
    .modalClose{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      min-width: 44px;
    }
    .modalBody{
      padding: 14px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }
    @media (max-width: 980px){
      .modalOverlay{ align-items: flex-end; padding: 12px; }
      .modal{ max-height: min(88dvh, 88vh); border-radius: 18px; }
    }

    /* Card modal layout */
    .cardModalRow{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 14px;
      align-items:start;
    }
    .cardModalRow img{
      width:120px;
      height:auto;
      aspect-ratio: 0.714;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:#07080c;
    }
    .cardModalMeta .big{
      font-size:20px;
      font-weight:900;
      line-height:1.2;
      margin-bottom:10px;
    }
    .btnGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btnWide{ grid-column: 1 / -1; }

    @media (max-width: 980px){
      .cardModalRow{ grid-template-columns: 96px 1fr; }
      .cardModalRow img{ width:96px; }
      .cardModalMeta .big{ font-size:18px; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin:10px 0;
    }
    .field input, .field select{ width:100%; }
    .hline{ height:1px; background:rgba(255,255,255,.08); margin:14px 0; }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <div class="tabsWrap" role="tablist" aria-label="画面切替">
      <div class="tabs">
        <button id="tabSearch" class="tabbtn" role="tab" aria-selected="true">検索</button>
        <button id="tabDeck" class="tabbtn" role="tab" aria-selected="false">デッキ</button>
      </div>
      <div class="pill" id="verBadge">ver 0.0.3</div>
    </div>
  </div>

  <!-- Search controls (layout per request) -->
  <div id="searchToolbar" class="searchToolbar">
    <div class="searchRow1">
      <input id="q" type="text" placeholder="検索" />
      <button id="btnSearch">検索</button>
    </div>

    <div class="searchRow2">
      <select id="order">
        <option value="name">並び（名前）</option>
        <option value="released">並び（発売日）</option>
        <option value="set">並び（セット）</option>
      </select>

      <button id="btnClear">クリア</button>

      <select id="viewMode" aria-label="表示モード">
        <option value="grid">表示（グリッド）</option>
        <option value="list">表示（リスト）</option>
      </select>
    </div>

    <div class="searchRow3">
      <label><input id="preferJa" type="checkbox" checked> 日本語版を優先（あれば）</label>
      <label><input id="collapseSame" type="checkbox"> 同名カードは1種類だけ（代表=最新印刷）</label>
    </div>
  </div>
</header>

<div class="content">
  <!-- ===== Search ===== -->
  <section id="viewSearch" class="view active">
    <div class="panel">
      <div id="resultsGrid" class="grid"></div>
      <div id="resultsList" class="list" style="display:none;"></div>
      <div id="status" class="status">待機中</div>
    </div>
  </section>

  <!-- ===== Deck ===== -->
  <section id="viewDeck" class="view">
    <div class="panel">
      <div class="deckWrap">
        <div class="deckTop">
          <div class="deckTopLeft">
            <span class="pill">現在: <b id="currentDeckName">（未保存）</b></span>
            <span class="pill">Main: <b id="mainCountTop">0</b></span>
            <span class="pill">Side: <b id="sideCountTop">0</b></span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <select id="sortDeck" aria-label="デッキ並び替え">
              <option value="name">並び（名前）</option>
              <option value="cmc">並び（マナコスト）</option>
              <option value="type">並び（種類）</option>
            </select>
            <button id="btnOpenSettings">⚙ 設定</button>
          </div>
        </div>

        <div class="boards">
          <div class="board">
            <div class="boardHead">
              <div class="boardHeadLeft">
                <div id="toggleMain" class="chev">▼</div>
                <div class="boardTitle">Main</div>
              </div>
              <div class="boardCount"><span id="mainCount">0</span>枚</div>
            </div>
            <div id="mainBody" class="tileWrap">
              <div id="mainTiles" class="tileGrid"></div>
            </div>
          </div>

          <div class="board">
            <div class="boardHead">
              <div class="boardHeadLeft">
                <div id="toggleSide" class="chev">▼</div>
                <div class="boardTitle">Side</div>
              </div>
              <div class="boardCount"><span id="sideCount">0</span>枚</div>
            </div>
            <div id="sideBody" class="tileWrap">
              <div id="sideTiles" class="tileGrid"></div>
            </div>
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnClearBoards" style="flex:1;">Main/Side 全消し</button>
        </div>
        <div class="status" id="deckStatus">待機中</div>
      </div>
    </div>
  </section>
</div>

<!-- ===== Card Operation Modal ===== -->
<div id="cardModalOverlay" class="modalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cardModalTitle">
    <div class="modalHeader">
      <div id="cardModalTitle" class="modalTitle">カード操作</div>
      <button class="modalClose" id="closeCardModal">×</button>
    </div>
    <div class="modalBody" id="cardModalBody"></div>
  </div>
</div>

<!-- ===== Deck Settings Modal ===== -->
<div id="settingsModalOverlay" class="modalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
    <div class="modalHeader">
      <div id="settingsModalTitle" class="modalTitle">デッキ設定</div>
      <button class="modalClose" id="closeSettingsModal">×</button>
    </div>
    <div class="modalBody">
      <div class="field">
        <label style="color:var(--muted); font-size:12px;">デッキ名</label>
        <input id="deckName" type="text" placeholder="例：テスト2" />
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnSaveDeck" style="flex:1;">保存</button>
        <button id="btnNewDeck" style="flex:1;">新規</button>
      </div>

      <div class="hline"></div>

      <div class="field">
        <label style="color:var(--muted); font-size:12px;">保存済みデッキ</label>
        <select id="deckSelect"></select>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnLoadDeck" style="flex:1;">読み込み</button>
        <button id="btnDeleteDeck" style="flex:1;">削除</button>
      </div>

      <div class="hline"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnCleanupZeros" style="flex:1;">0枚カードを掃除</button>
      </div>

      <div style="margin-top:10px; font-size:12px; color:var(--muted); text-align:center;">
        ※エクスポート機能は必要なら復活できます
      </div>
    </div>
  </div>
</div>

<script src="./app.js"></script>
  
<!-- Service Worker -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./se.js").catch(() => {});
}
</script>

</body>
</html>

